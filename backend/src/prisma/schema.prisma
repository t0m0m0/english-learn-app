generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  Int                 @id @default(autoincrement())
  email               String              @unique
  name                String
  progress            Progress[]
  lessons             Lesson[]
  callanProgress      CallanProgress[]
  listeningProgress   ListeningProgress[]
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
}

model Word {
  id           Int        @id @default(autoincrement())
  word         String     @unique
  frequency    Int        // 頻度順位 (1-3000)
  partOfSpeech String?    // 品詞 (noun, verb, adjective, etc.)
  progress     Progress[]
  createdAt    DateTime   @default(now())
}

model Progress {
  id           Int       @id @default(autoincrement())
  userId       Int
  wordId       Int
  level        Int       @default(0)  // 習熟度 0-5
  lastReviewed DateTime?
  nextReview   DateTime?
  reviewCount  Int       @default(0)
  correctCount Int       @default(0)
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  word         Word      @relation(fields: [wordId], references: [id], onDelete: Cascade)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@unique([userId, wordId])
}

model Lesson {
  id          String   @id @default(uuid())
  title       String   // "Stage 1 - Lesson 1" など
  description String?
  order       Int      // レッスンの順序
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  userId      Int
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  qaItems     QAItem[]
}

model QAItem {
  id           String   @id @default(uuid())
  question     String   // 質問文
  answer       String   // 回答文
  order        Int      // レッスン内の順序
  lessonId     String
  lesson       Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  progresses   CallanProgress[]
}

model CallanProgress {
  id            String    @id @default(uuid())
  userId        Int
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  qaItemId      String
  qaItem        QAItem    @relation(fields: [qaItemId], references: [id], onDelete: Cascade)
  mode          String    // "qa" | "shadowing" | "dictation"
  correctCount  Int       @default(0)
  totalCount    Int       @default(0)
  lastPracticed DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([userId, qaItemId, mode])
}

model ListeningPassage {
  id         String              @id @default(uuid())
  title      String
  text       String              // パッセージ本文
  difficulty String              // beginner, intermediate, advanced
  topic      String?             // トピックカテゴリ
  order      Int                 // 表示順
  questions  ListeningQuestion[]
  createdAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt
}

model ListeningQuestion {
  id         String              @id @default(uuid())
  passageId  String
  passage    ListeningPassage    @relation(fields: [passageId], references: [id], onDelete: Cascade)
  type       String              // multiple_choice, true_false, fill_blank
  question   String
  options    String?             // JSON array for multiple choice options
  answer     String
  order      Int
  progresses ListeningProgress[]
  createdAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt
}

model ListeningProgress {
  id         String            @id @default(uuid())
  userId     Int
  user       User              @relation(fields: [userId], references: [id])
  questionId String
  question   ListeningQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  isCorrect  Boolean
  answeredAt DateTime          @default(now())

  @@index([userId, questionId])
}
